<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>เกมแฟลชการ์ดภาษาอังกฤษ (EN ⇄ TH)</title>
<style>
  :root{
    --bg:#0b0f14;
    --card:#121821;
    --ink:#e9eef5;
    --muted:#9fb0c3;
    --accent:#72d2ff;
    --good:#56d364;
    --bad:#ff7b72;
    --btn:#182233;
    --btn2:#1f2a3d;
  }
  *{box-sizing:border-box}
  body{
    margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans Thai", "Noto Sans", sans-serif;
    background:linear-gradient(180deg,#0b0f14 0%,#0b1017 50%,#0b0f14 100%);
    color:var(--ink);
    min-height:100svh; display:flex; flex-direction:column; gap:16px;
  }
  header{
    padding:16px 20px; display:flex; align-items:center; gap:12px; flex-wrap:wrap; justify-content:space-between;
    background:rgba(255,255,255,0.02); backdrop-filter: blur(6px); position:sticky; top:0; z-index:10; border-bottom:1px solid rgba(255,255,255,0.06);
  }
  header .title{font-weight:700}
  header .controls{display:flex; gap:8px; flex-wrap:wrap}
  button, select{
    background:var(--btn); color:var(--ink); border:1px solid rgba(255,255,255,0.08); border-radius:12px;
    padding:10px 14px; cursor:pointer; font-size:14px;
  }
  button:hover{background:var(--btn2)}
  button.primary{background:var(--accent); color:#001018; border:none; font-weight:700}
  button.good{background:rgba(86,211,100,0.15); border:1px solid rgba(86,211,100,0.35)}
  button.bad{background:rgba(255,123,114,0.12); border:1px solid rgba(255,123,114,0.32)}
  main{display:grid; place-items:center; padding:8px 16px 24px}
  .wrap{display:flex; flex-direction:column; gap:14px; max-width:900px; width:100%}
  .stats{display:flex; gap:12px; flex-wrap:wrap; align-items:center}
  .pill{
    background:rgba(255,255,255,0.06); padding:8px 12px; border-radius:999px; font-size:13px; color:var(--muted); border:1px solid rgba(255,255,255,0.08)
  }
  .big{
    display:grid; gap:14px; grid-template-columns:1fr; align-items:center; justify-items:center;
  }
  .card{
    width:min(95vw,780px); aspect-ratio: 16/10; background:linear-gradient(180deg,#141c27,#0f1520);
    border-radius:18px; border:1px solid rgba(255,255,255,0.09); display:flex; align-items:center; justify-content:center;
    padding:24px; position:relative; cursor:pointer; user-select:none; transform: translateZ(0); transition: transform 200ms ease, box-shadow 200ms ease;
    box-shadow: 0 10px 30px rgba(0,0,0,.25);
  }
  .card:hover{transform: translateY(-2px)}
  .side{
    text-align:center; max-width:90%; line-height:1.3; font-size: clamp(22px, 3.6vw, 44px); letter-spacing: 0.3px;
  }
  .sub{color:var(--muted); font-size: clamp(13px, 2vw, 16px); line-height:1.35; margin-top:10px}
  .hint{position:absolute; bottom:12px; right:16px; font-size:12px; color:var(--muted)}
  .toolbar{display:flex; gap:8px; flex-wrap:wrap; justify-content:center}
  .toolbar input[type="text"]{
    background:#0f1520; border:1px solid rgba(255,255,255,0.08); border-radius:10px; padding:10px 12px; color:var(--ink); width:200px;
  }
  .grid{
    display:grid; grid-template-columns: repeat(auto-fit,minmax(180px,1fr)); gap:10px; width:100%;
  }
  details{
    background:rgba(255,255,255,0.04); border:1px solid rgba(255,255,255,0.08); border-radius:12px; padding:10px 12px
  }
  summary{cursor:pointer; color:var(--muted)}
  textarea{
    width:100%; min-height:160px; background:#0f1520; border:1px solid rgba(255,255,255,0.1); border-radius:12px; color:var(--ink); padding:12px; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, "Courier New", monospace;
  }
  .foot{color:var(--muted); font-size:12px; text-align:center; padding-bottom:12px}
</style>
</head>
<body>
  <header>
    <div class="title">✨ เกมแฟลชการ์ดภาษาอังกฤษ (คลิกการ์ดเพื่อพลิก)</div>
    <div class="controls">
      <select id="mode">
        <option value="en-th">โหมด: อังกฤษ ➜ ไทย</option>
        <option value="th-en">โหมด: ไทย ➜ อังกฤษ</option>
      </select>
      <select id="deckSelect"></select>
      <button id="shuffleBtn" title="สับไพ่ (R)">สับไพ่</button>
      <button id="ttsBtn" title="อ่านออกเสียง (S)">อ่านคำ</button>
      <button id="knownBtn" class="good" title="ฉันตอบถูก (K)">ฉันตอบถูก ✓</button>
      <button id="unknownBtn" class="bad" title="ฉันยังจำไม่ได้ (F)">ยังจำไม่ได้ ✗</button>
      <button id="nextBtn" class="primary" title="ถัดไป (Space)">ถัดไป</button>
    </div>
  </header>

  <main>
    <div class="wrap">
      <div class="stats">
        <div class="pill">การ์ดคงเหลือ: <b id="leftCount">0</b></div>
        <div class="pill">คะแนนถูก: <b id="correct">0</b></div>
        <div class="pill">ผิด/ข้าม: <b id="wrong">0</b></div>
        <div class="pill">ความแม่นยำ: <b id="accuracy">0%</b></div>
        <div class="pill">สตรีค: <b id="streak">0</b></div>
      </div>

      <div class="big">
        <div class="card" id="card" role="button" aria-pressed="false">
          <div class="side" id="front"></div>
          <div class="side" id="back" style="display:none"></div>
          <div class="hint">กด Space เพื่อพลิก / ปุ่มลูกศรถัดไปเพื่อไปการ์ดถัดไป</div>
        </div>

        <div class="toolbar">
          <div class="grid" style="max-width:780px">
            <button id="flipBtn" title="พลิกการ์ด (Space)">พลิกการ์ด</button>
            <button id="reviewWrongBtn" title="เล่นเฉพาะที่ทำผิด">เล่นเฉพาะที่ทำผิด</button>
            <button id="resetStatsBtn" title="รีเซ็ตสถิติ">รีเซ็ตสถิติ</button>
            <button id="exportBtn" title="ส่งออกเด็คเป็น JSON">ส่งออกเด็ค</button>
            <button id="importBtn" title="นำเข้าเด็คจาก JSON">นำเข้าเด็ค</button>
            <input type="text" id="search" placeholder="ค้นหาคำ / ความหมาย" />
            <button id="addBtn">เพิ่มการ์ดเอง</button>
          </div>
        </div>

        <details>
          <summary>เพิ่ม/แก้ไขเด็ค (รูปแบบ JSON) • คลิกเพื่อแสดง</summary>
          <p class="sub">รูปแบบข้อมูลเด็ค:</p>
          <pre class="sub" style="white-space:pre-wrap; background:#0d121b; padding:10px; border-radius:10px; border:1px solid rgba(255,255,255,.08)">
{
  "name": "พื้นฐาน",
  "cards": [
    {"en":"apple","th":"แอปเปิ้ล","ex":"I eat an apple every morning."},
    {"en":"travel","th":"ท่องเที่ยว","ex":"We love to travel during holidays."}
  ]
}
          </pre>
          <textarea id="deckEditor"></textarea>
          <div style="display:flex; gap:8px; margin-top:8px">
            <button id="applyDeckBtn" class="primary">นำไปใช้กับเด็คปัจจุบัน</button>
            <button id="downloadDeckBtn">ดาวน์โหลดไฟล์เด็ค (.json)</button>
          </div>
        </details>

        <p class="foot">เคล็ดลับ: ปุ่มลัด — Space: พลิก/ถัดไป • R: สับไพ่ • S: อ่านคำ • K: ถูก • F: ยังจำไม่ได้ • /: ค้นหา</p>
      </div>
    </div>
  </main>

<script>
const defaultDecks = [
  {
    name: "พื้นฐาน A1",
    cards: [
      {en:"apple", th:"แอปเปิ้ล", ex:"I eat an apple every morning."},
      {en:"book", th:"หนังสือ", ex:"This book is very interesting."},
      {en:"family", th:"ครอบครัว", ex:"My family lives in Bangkok."},
      {en:"friend", th:"เพื่อน", ex:"He is my best friend."},
      {en:"travel", th:"ท่องเที่ยว", ex:"We travel every summer."},
      {en:"learn", th:"เรียนรู้", ex:"I want to learn English well."},
      {en:"work", th:"ทำงาน", ex:"She works at a bank."},
      {en:"school", th:"โรงเรียน", ex:"The school is near my house."},
      {en:"food", th:"อาหาร", ex:"Thai food is delicious."},
      {en:"water", th:"น้ำ", ex:"Drink more water."},
      {en:"music", th:"ดนตรี", ex:"I listen to music at night."},
      {en:"movie", th:"ภาพยนตร์", ex:"We watched a movie yesterday."},
      {en:"health", th:"สุขภาพ", ex:"Health is more important than wealth."},
      {en:"happy", th:"มีความสุข", ex:"I am happy to see you."},
      {en:"practice", th:"ฝึกฝน", ex:"Practice makes perfect."},
      {en:"city", th:"เมือง", ex:"Bangkok is a big city."},
      {en:"market", th:"ตลาด", ex:"The market opens at 6 a.m."},
      {en:"price", th:"ราคา", ex:"The price is too high."},
      {en:"cheap", th:"ราคาถูก", ex:"This shirt is cheap and good."},
      {en:"beautiful", th:"สวยงาม", ex:"The temple is beautiful."}
    ]
  },
  {
    name: "คำกริยาใช้บ่อย",
    cards: [
      {en:"go", th:"ไป", ex:"I go to work by bus."},
      {en:"come", th:"มา", ex:"Please come here."},
      {en:"take", th:"เอา/พา/รับ", ex:"Take an umbrella with you."},
      {en:"make", th:"ทำ/สร้าง", ex:"They make cakes on Sundays."},
      {en:"get", th:"ได้/รับ", ex:"I get many emails every day."},
      {en:"need", th:"ต้องการ", ex:"We need more time."},
      {en:"want", th:"ต้องการ/อยาก", ex:"I want a new phone."},
      {en:"like", th:"ชอบ", ex:"Do you like coffee?"},
      {en:"know", th:"รู้", ex:"She knows the answer."},
      {en:"think", th:"คิด", ex:"I think it's going to rain."},
      {en:"tell", th:"บอก/เล่า", ex:"Tell me the truth."},
      {en:"call", th:"โทร/เรียก", ex:"Call me later."},
      {en:"try", th:"ลอง/พยายาม", ex:"Try your best."},
      {en:"use", th:"ใช้", ex:"Use this key to open the door."},
      {en:"find", th:"หา/พบ", ex:"I can't find my keys."}
    ]
  }
];

const el = (id)=>document.getElementById(id);
const front = el("front");
const back  = el("back");
const card  = el("card");

const state = {
  decks: [],
  deckIndex: 0,
  queue: [], // indexes of cards
  current: 0,
  showBack: false,
  correct: 0,
  wrong: 0,
  streak: 0,
  wrongSet: new Set(),
  mode: "en-th", // en-th | th-en
};

function saveLocal(){
  const data = {
    decks: state.decks,
    deckIndex: state.deckIndex,
    stats: {correct: state.correct, wrong: state.wrong, streak: state.streak},
    wrongSet: [...state.wrongSet],
    mode: state.mode
  };
  localStorage.setItem("en_th_flashcards_v1", JSON.stringify(data));
}

function loadLocal(){
  try{
    const raw = localStorage.getItem("en_th_flashcards_v1");
    if(!raw) return false;
    const data = JSON.parse(raw);
    state.decks = data.decks?.length ? data.decks : defaultDecks;
    state.deckIndex = data.deckIndex ?? 0;
    state.correct = data.stats?.correct ?? 0;
    state.wrong = data.stats?.wrong ?? 0;
    state.streak = data.stats?.streak ?? 0;
    state.wrongSet = new Set(data.wrongSet ?? []);
    state.mode = data.mode ?? "en-th";
    return true;
  }catch(e){ console.warn(e); return false; }
}

function init(){
  if(!loadLocal()){
    state.decks = defaultDecks;
  }
  // build deck select
  refreshDeckSelect();
  el("mode").value = state.mode;
  startDeck(state.deckIndex);
  wireEvents();
}

function refreshDeckSelect(){
  const sel = el("deckSelect");
  sel.innerHTML = "";
  state.decks.forEach((d, i)=>{
    const opt = document.createElement("option");
    opt.value = i; opt.textContent = `เด็ค: ${d.name} (${d.cards.length})`;
    sel.appendChild(opt);
  });
  sel.value = state.deckIndex;
}

function startDeck(idx){
  state.deckIndex = Number(idx) || 0;
  const deck = state.decks[state.deckIndex];
  state.queue = Array.from(deck.cards.keys());
  shuffle(state.queue);
  state.current = 0;
  state.showBack = false;
  updateCard();
  updateStats();
  el("deckEditor").value = JSON.stringify(deck, null, 2);
  saveLocal();
}

function shuffle(arr){
  for(let i=arr.length-1; i>0; i--){
    const j = Math.floor(Math.random()*(i+1));
    [arr[i], arr[j]] = [arr[j], arr[i]];
  }
}

function formatCard(c){
  if(state.mode === "en-th"){
    front.innerHTML = `<div><div style="font-weight:800">${escapeHTML(c.en)}</div>` +
      (c.ph?`<div class="sub">/${escapeHTML(c.ph)}/</div>`:"") + `</div>`;
    back.innerHTML  = `<div><div style="font-weight:700">${escapeHTML(c.th)}</div>` +
      (c.ex?`<div class="sub">Example: ${escapeHTML(c.ex)}</div>`:"") + `</div>`;
  }else{
    front.innerHTML = `<div><div style="font-weight:800">${escapeHTML(c.th)}</div></div>`;
    back.innerHTML  = `<div><div style="font-weight:700">${escapeHTML(c.en)}</div>` +
      (c.ex?`<div class="sub">Example: ${escapeHTML(c.ex)}</div>`:"") + `</div>`;
  }
}

function escapeHTML(s){
  return String(s ?? "").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
}

function currentCard(){
  const deck = state.decks[state.deckIndex];
  const idx = state.queue[state.current] ?? 0;
  return deck.cards[idx];
}

function updateCard(){
  const c = currentCard();
  if(!c){ front.textContent = "จบเด็คแล้ว!"; back.textContent = ""; return; }
  formatCard(c);
  back.style.display = state.showBack ? "block" : "none";
  front.style.display = state.showBack ? "none" : "block";
  el("leftCount").textContent = (state.queue.length - state.current);
}

function flip(){
  state.showBack = !state.showBack;
  updateCard();
}

function speak(){
  try{
    const c = currentCard(); if(!c) return;
    const utter = new SpeechSynthesisUtterance(state.mode==='en-th' ? c.en : c.en);
    utter.lang = "en-US";
    window.speechSynthesis.cancel();
    window.speechSynthesis.speak(utter);
  }catch(e){ console.warn("TTS failed", e); }
}

function nextCard(){
  if(state.current < state.queue.length-1){
    state.current += 1;
    state.showBack = false;
    updateCard();
  }else{
    front.innerHTML = "<b>เยี่ยมมาก! เล่นครบแล้ว 🎉</b>";
    back.style.display = "none";
  }
  updateStats();
  saveLocal();
}

function markKnown(isKnown){
  const deck = state.decks[state.deckIndex];
  const idx = state.queue[state.current];
  if(isKnown){
    state.correct += 1;
    state.streak += 1;
    state.wrongSet.delete(idx);
  }else{
    state.wrong += 1;
    state.streak = 0;
    // ส่งการ์ดใบนี้ไปข้างหลังของคิว เพื่อทบทวนซ้ำแบบ spaced-repetition เบื้องต้น
    state.queue.push(idx);
    state.wrongSet.add(idx);
  }
  updateStats();
  saveLocal();
}

function updateStats(){
  const total = state.correct + state.wrong;
  const acc = total ? Math.round((state.correct/total)*100) : 0;
  el("correct").textContent = state.correct;
  el("wrong").textContent = state.wrong;
  el("accuracy").textContent = acc + "%";
  el("streak").textContent = state.streak;
  el("leftCount").textContent = Math.max(0, state.queue.length - state.current);
}

function reviewWrongOnly(){
  const wrongIdx = [...state.wrongSet];
  if(wrongIdx.length === 0){ alert("ยังไม่มีการ์ดที่ทำผิด"); return; }
  state.queue = wrongIdx.slice();
  shuffle(state.queue);
  state.current = 0;
  state.showBack = false;
  updateCard();
  updateStats();
  saveLocal();
}

function resetStats(){
  if(!confirm("รีเซ็ตสถิติ (ถูก/ผิด/สตรีค) ทั้งหมด?")) return;
  state.correct = 0; state.wrong = 0; state.streak = 0; state.wrongSet.clear();
  updateStats(); saveLocal();
}

function applyEditorToDeck(){
  try{
    const data = JSON.parse(el("deckEditor").value);
    if(!data.name || !Array.isArray(data.cards)) throw new Error("รูปแบบไม่ถูกต้อง");
    state.decks[state.deckIndex] = data;
    refreshDeckSelect();
    startDeck(state.deckIndex);
  }catch(e){
    alert("ไม่สามารถอ่าน JSON ได้: " + e.message);
  }
}

function downloadDeck(){
  const data = el("deckEditor").value;
  const blob = new Blob([data], {type:"application/json"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url; a.download = `deck_${Date.now()}.json`; a.click();
  setTimeout(()=>URL.revokeObjectURL(url), 1000);
}

function exportCurrentDeck(){
  const deck = state.decks[state.deckIndex];
  const blob = new Blob([JSON.stringify(deck, null, 2)], {type:"application/json"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url; a.download = `${deck.name.replace(/\s+/g,'_')}.json`; a.click();
  setTimeout(()=>URL.revokeObjectURL(url), 1000);
}

function importDeck(){
  const inp = document.createElement("input");
  inp.type = "file"; inp.accept = ".json,application/json";
  inp.onchange = (e)=>{
    const file = e.target.files?.[0]; if(!file) return;
    const reader = new FileReader();
    reader.onload = ()=>{
      try{
        const data = JSON.parse(String(reader.result));
        if(!data.name || !Array.isArray(data.cards)) throw new Error("รูปแบบไม่ถูกต้อง");
        state.decks.push(data);
        refreshDeckSelect();
        state.deckIndex = state.decks.length - 1;
        startDeck(state.deckIndex);
      }catch(err){
        alert("ไฟล์ไม่ถูกต้อง: " + err.message);
      }
    };
    reader.readAsText(file);
  };
  inp.click();
}

function addCardQuick(){
  const en = prompt("ใส่คำอังกฤษ (EN):"); if(!en) return;
  const th = prompt("ใส่คำแปลไทย (TH):") || "";
  const ex = prompt("ตัวอย่างประโยค (ไม่บังคับ):") || "";
  const deck = state.decks[state.deckIndex];
  deck.cards.push({en, th, ex});
  el("deckEditor").value = JSON.stringify(deck, null, 2);
  startDeck(state.deckIndex);
}

function searchFilter(){
  const q = el("search").value.trim().toLowerCase();
  const deck = state.decks[state.deckIndex];
  if(!q){ startDeck(state.deckIndex); return; }
  const matched = [];
  deck.cards.forEach((c, i)=>{
    const hay = `${c.en} ${c.th} ${c.ex||""}`.toLowerCase();
    if(hay.includes(q)) matched.push(i);
  });
  if(matched.length===0){ alert("ไม่พบคำที่ค้นหา"); return; }
  state.queue = matched;
  state.current = 0; state.showBack=false;
  updateCard(); updateStats();
}

function wireEvents(){
  card.addEventListener("click", flip);
  el("flipBtn").addEventListener("click", flip);
  el("ttsBtn").addEventListener("click", speak);
  el("nextBtn").addEventListener("click", nextCard);
  el("shuffleBtn").addEventListener("click", ()=>{ shuffle(state.queue); state.current=0; state.showBack=false; updateCard(); saveLocal(); });
  el("knownBtn").addEventListener("click", ()=>{ markKnown(true); nextCard(); });
  el("unknownBtn").addEventListener("click", ()=>{ markKnown(false); nextCard(); });

  el("deckSelect").addEventListener("change", (e)=> startDeck(e.target.value));
  el("mode").addEventListener("change", (e)=>{ state.mode=e.target.value; updateCard(); saveLocal(); });

  el("reviewWrongBtn").addEventListener("click", reviewWrongOnly);
  el("resetStatsBtn").addEventListener("click", resetStats);
  el("applyDeckBtn").addEventListener("click", applyEditorToDeck);
  el("downloadDeckBtn").addEventListener("click", downloadDeck);
  el("exportBtn").addEventListener("click", exportCurrentDeck);
  el("importBtn").addEventListener("click", importDeck);
  el("addBtn").addEventListener("click", addCardQuick);
  el("search").addEventListener("keydown", (e)=>{ if(e.key==="Enter") searchFilter(); });

  document.addEventListener("keydown", (e)=>{
    if(e.target === el("search")) return;
    if(e.key === " "){ e.preventDefault(); if(!state.showBack) flip(); else nextCard(); }
    else if(e.key.toLowerCase() === "r"){ shuffle(state.queue); state.current=0; state.showBack=false; updateCard(); }
    else if(e.key.toLowerCase() === "s"){ speak(); }
    else if(e.key.toLowerCase() === "k"){ markKnown(true); nextCard(); }
    else if(e.key.toLowerCase() === "f"){ markKnown(false); nextCard(); }
    else if(e.key === "ArrowRight"){ nextCard(); }
    else if(e.key === "/"){ e.preventDefault(); el("search").focus(); }
  });
}

init();
</script>
</body>
</html>
